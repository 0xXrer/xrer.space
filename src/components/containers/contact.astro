---
import Container from "@/components/container.astro";
import Grid from "@/components/patters/grid.astro";
import portfolioConfig from "@/config/portfolio";
import { TranslatedText } from "@/components/translated-text";

const { contact } = portfolioConfig;

// Fetch Discord user avatar if ID is provided
let discordAvatar = null;
if (contact.discordId) {
    try {
        const response = await fetch(
            `https://discord.com/api/v10/users/${contact.discordId}`,
            {
                headers: {
                    Authorization: `Bot ${import.meta.env.DISCORD_BOT_TOKEN}`,
                },
            },
        );

        if (response.ok) {
            const user = await response.json();
            discordAvatar = user.avatar
                ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.${user.avatar.startsWith("a_") ? "gif" : "png"}?size=128`
                : null;
        }
    } catch (e) {
        // Fallback to default if API fails
        console.log("Discord API unavailable, using fallback avatar");
    }
}
---

<Container showTopLine={false} showBottomLine={false}>
    <Grid
        patternSize={24}
        enableGradient={true}
        gradientSize={90}
        gradientDirection={"to-bottom"}
        class="absolute inset-0 w-full h-full opacity-20 pointer-events-none"
    />
    <section class="p-6">
        <div class="bg-background w-full p-6">
            <div class="flex flex-col items-center text-center space-y-4">
                <!-- Discord Icon -->
                <div
                    class="flex-shrink-0 p-0.5 bg-background border border-2 rounded-lg"
                >
                    <div
                        class="pointer-events-none select-none w-18 h-18 rounded-lg flex items-center justify-center outline outline-dashed outline-2 outline-offset-[-1px] outline-border text-foreground"
                    >
                        <div
                            class="flex h-16 w-16 items-center justify-center rounded-md bg-[#5865F2] text-white"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="42"
                                height="42"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                            >
                                <path
                                    d="M20.317 4.492c-1.53-.69-3.17-1.2-4.885-1.49a.075.075 0 0 0-.079.036c-.21.369-.444.85-.608 1.23a18.566 18.566 0 0 0-5.487 0 12.36 12.36 0 0 0-.617-1.23A.077.077 0 0 0 8.562 3c-1.714.29-3.354.8-4.885 1.491a.07.07 0 0 0-.032.027C.533 9.093-.32 13.555.099 17.961a.08.08 0 0 0 .031.055 20.03 20.03 0 0 0 5.993 2.98.078.078 0 0 0 .084-.026 13.83 13.83 0 0 0 1.226-1.963.074.074 0 0 0-.041-.104 13.201 13.201 0 0 1-1.872-.878.075.075 0 0 1-.008-.125c.126-.093.252-.19.372-.287a.075.075 0 0 1 .078-.01c3.927 1.764 8.18 1.764 12.061 0a.075.075 0 0 1 .079.009c.12.098.245.195.372.288a.075.075 0 0 1-.006.125c-.598.344-1.22.635-1.873.877a.075.075 0 0 0-.041.105c.36.687.772 1.341 1.225 1.962a.077.077 0 0 0 .084.028 19.963 19.963 0 0 0 6.002-2.981.076.076 0 0 0 .032-.054c.5-5.094-.838-9.52-3.549-13.442a.06.06 0 0 0-.031-.028zM8.02 15.278c-1.182 0-2.157-1.069-2.157-2.38 0-1.312.956-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.956 2.38-2.157 2.38zm7.975 0c-1.183 0-2.157-1.069-2.157-2.38 0-1.312.955-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.946 2.38-2.157 2.38z"
                                ></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Section Badge -->
                <TranslatedText
                    path="contact.badge"
                    as="span"
                    className="text-xs text-muted-foreground uppercase tracking-wider font-medium"
                    client:load
                />

                <!-- Section Title -->
                <TranslatedText
                    path="contact.title"
                    as="h2"
                    className="text-2xl font-bold"
                    client:load
                />

                <!-- Section Description -->
                <TranslatedText
                    path="contact.description"
                    as="p"
                    className="text-muted-foreground leading-relaxed max-w-2xl"
                    client:load
                />

                <!-- Discord Contact Card -->
                {
                    contact.discord && (
                        <div class="w-full max-w-md mt-6">
                            <div class="group relative overflow-hidden rounded-lg border border-border bg-card p-6 transition-all hover:border-primary/50 hover:shadow-lg">
                                <Grid
                                    patternSize={16}
                                    enableGradient={false}
                                    class="absolute inset-0 w-full h-full opacity-10 pointer-events-none"
                                />

                                <div class="relative z-10 flex flex-col items-start space-y-4">
                                    <!-- Avatar and Nickname Row -->
                                    <div class="flex items-center gap-3">
                                        <!-- Avatar Discord -->
                                        <div class="h-14 w-14 rounded-full overflow-hidden bg-muted">
                                            {discordAvatar ? (
                                                <img
                                                    src={discordAvatar}
                                                    alt={contact.discord}
                                                    class="h-full w-full object-cover"
                                                />
                                            ) : (
                                                <div class="flex h-full w-full items-center justify-center bg-[#5865F2] text-white text-xl font-bold">
                                                    {contact.discord?.charAt(0).toUpperCase()}
                                                </div>
                                            )}
                                        </div>

                                        <div class="text-left">
                                            <!-- Nickname -->
                                            <h3 class="text-lg font-bold text-foreground">
                                                {contact.discord}
                                            </h3>
                                            <!-- Description -->
                                            <TranslatedText
                                                path="contact.discord.description"
                                                as="p"
                                                className="text-sm text-muted-foreground"
                                                client:load
                                            />
                                        </div>
                                    </div>

                                    <!-- Open Discord Button -->
                                    <a
                                        href={`https://discord.com/users/${contact.discordId || ""}`}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="inline-flex items-center gap-2 rounded-lg bg-[#5865F2] px-5 py-2.5 text-sm font-semibold text-white transition-all hover:bg-[#4752C4] hover:shadow-lg w-full"
                                    >
                                        <TranslatedText
                                            path="contact.discord.button"
                                            client:load
                                        />
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="16"
                                            height="16"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        >
                                            <path d="M7 7h10v10" />
                                            <path d="M7 17 17 7" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    )
                }
            </div>
        </div>
    </section>
</Container>
