---
import Container from "@/components/container.astro";
import Grid from "@/components/patters/grid.astro";
import GitHubRepoCard from "@/components/GitHubRepoCard.astro";
import GitHubIcon from "@/components/icons/GitHubIcon.astro";
import portfolioConfig from "@/config/portfolio";
import { TranslatedText } from "@/components/translated-text";

const { personal } = portfolioConfig;

// Extract GitHub username from URL
const githubUsername =
    personal.socialLinks.github?.split("github.com/")[1] || "0xXrer";

// Fetch public repositories from GitHub API
let repositories = [];
let error = null;

// Prepare headers with optional GitHub token from environment
const headers: HeadersInit = {
    Accept: "application/vnd.github.v3+json",
};

// Add GitHub token if available (increases rate limit from 60 to 5000 requests/hour)
const githubToken = import.meta.env.GITHUB_TOKEN;
if (githubToken) {
    headers.Authorization = `token ${githubToken}`;
}

try {
    const response = await fetch(
        `https://api.github.com/users/${githubUsername}/repos?sort=updated&per_page=100`,
        { headers },
    );

    if (response.ok) {
        const repos = await response.json();

        // Filter only public, non-archived, non-fork repositories
        const filteredRepos = repos
            .filter((repo) => !repo.private && !repo.archived && !repo.fork)
            .sort(
                (a, b) =>
                    new Date(b.updated_at).getTime() -
                    new Date(a.updated_at).getTime(),
            )
            .slice(0, 12); // Show top 12 most recently updated repos

        // Fetch social preview images for each repository
        repositories = await Promise.all(
            filteredRepos.map(async (repo) => {
                let ogImage = null;
                try {
                    // Fetch the actual HTML page to extract the og:image meta tag
                    const pageResponse = await fetch(
                        `https://github.com/${githubUsername}/${repo.name}`,
                        {
                            headers: {
                                "User-Agent":
                                    "Mozilla/5.0 (compatible; Bot/1.0)",
                            },
                        },
                    );

                    if (pageResponse.ok) {
                        const html = await pageResponse.text();

                        // Extract og:image from meta tags
                        const ogImageMatch = html.match(
                            /<meta property="og:image" content="([^"]+)"/,
                        );

                        if (ogImageMatch && ogImageMatch[1]) {
                            ogImage = ogImageMatch[1];
                        }
                    }

                    // Fallback to auto-generated OG image if extraction fails
                    if (!ogImage) {
                        ogImage = `https://opengraph.githubassets.com/1/${githubUsername}/${repo.name}`;
                    }
                } catch (e) {
                    console.error(
                        `Failed to get preview image for ${repo.name}:`,
                        e,
                    );
                    // Fallback to auto-generated OG image
                    ogImage = `https://opengraph.githubassets.com/1/${githubUsername}/${repo.name}`;
                }

                return {
                    ...repo,
                    ogImage,
                };
            }),
        );
    } else {
        if (response.status === 403) {
            error =
                "GitHub API rate limit exceeded. Please try again later or add a GITHUB_TOKEN to your .env file.";
        } else {
            error = `Failed to fetch repositories: ${response.status}`;
        }
    }
} catch (e) {
    error = `Error fetching repositories: ${e.message}`;
    console.error("GitHub API Error:", e);
}
---

<Container showTopLine={true}>
    <section class="p-6">
        <div class="bg-background w-full p-6">
            <div class="flex flex-col items-center text-center space-y-4">
                <!-- GitHub Icon -->
                <div
                    class="flex-shrink-0 p-0.5 bg-background border border-2 rounded-lg"
                >
                    <a
                        href={personal.socialLinks.github || "#"}
                        target="_blank"
                    >
                        <div
                            class="pointer-events-none select-none w-18 h-18 rounded-lg flex items-center justify-center outline outline-dashed outline-2 outline-offset-[-1px] outline-border text-foreground"
                        >
                            <GitHubIcon width="72" height="72" />
                        </div>
                    </a>
                </div>

                <!-- Section Badge -->
                <TranslatedText
                    path="github.badge"
                    as="span"
                    className="text-xs text-muted-foreground uppercase tracking-wider font-medium"
                    client:load
                />

                <!-- Section Description -->
                <TranslatedText
                    path="github.description"
                    as="p"
                    className="text-muted-foreground leading-relaxed"
                    client:load
                />

                {
                    error && (
                        <div class="w-full p-4 bg-destructive/10 border border-destructive/30 rounded-lg">
                            <p class="text-destructive text-sm">{error}</p>
                        </div>
                    )
                }

                {
                    repositories.length > 0 && (
                        <div class="w-full grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
                            {repositories.map((repo) => (
                                <GitHubRepoCard repo={repo} />
                            ))}
                        </div>
                    )
                }

                {
                    !error && repositories.length === 0 && (
                        <div class="w-full p-8 text-center">
                            <TranslatedText
                                path="github.noRepos"
                                as="p"
                                className="text-muted-foreground"
                                client:load
                            />
                        </div>
                    )
                }

                <!-- View All on GitHub Button -->
                {
                    repositories.length > 0 && (
                        <div class="pt-4">
                            <a
                                href={personal.socialLinks.github || "#"}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="inline-flex items-center gap-2 px-4 py-2 bg-primary/10 text-primary hover:bg-primary/20 border border-primary/30 rounded-md transition-colors text-sm"
                            >
                                <TranslatedText
                                    path="github.viewAll"
                                    client:load
                                />
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <path d="M7 7h10v10" />
                                    <path d="M7 17 17 7" />
                                </svg>
                            </a>
                        </div>
                    )
                }
            </div>
        </div>
    </section>
</Container>
